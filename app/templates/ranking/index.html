{% extends "base.html" %}

{% block title %}국회.gg - {{ title }} 랭킹{% endblock %}

{% block extra_head %}
<style>
    .sortable {
        cursor: pointer;
    }
    .sort-icon::after {
        content: "";
        margin-left: 5px;
    }
    .sort-asc::after {
        content: " ▲";
    }
    .sort-desc::after {
        content: " ▼";
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">활동 랭킹 {% if current_category != 'overall' %}- {{ title }}{% endif %}</h1>
    
    <!-- TOP 5 & BOTTOM 5 영역 -->
    <div class="row mb-5">
        <!-- 상위 5명 -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>{{ title }} Best 5</h5>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="top-view" id="top-chart-btn" autocomplete="off" checked>
                        <label class="btn btn-outline-primary btn-sm" for="top-chart-btn">차트</label>
                        
                        <input type="radio" class="btn-check" name="top-view" id="top-table-btn" autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="top-table-btn">목록</label>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 차트 뷰 -->
                    <div id="top-chart-view">
                        <canvas id="topChart" height="300"></canvas>
                    </div>
                    
                    <!-- 테이블 뷰 -->
                    <div id="top-table-view" class="d-none">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>순위</th>
                                    <th>사진</th>
                                    <th>의원명</th>
                                    <th>정당</th>
                                    <th>티어</th>
                                    <th>{{ title }} 점수</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for legislator in top_legislators %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>
                                        <img src="{{ legislator.profile_image_url }}" alt="{{ legislator.name }}" 
                                             class="rounded-circle" width="40" height="40" loading="lazy">
                                    </td>
                                    <td>
                                        <a href="/champions/{{ legislator.id }}">
                                            {{ legislator.name }}
                                        </a>
                                    </td>
                                    <td>{{ legislator.party }}</td>
                                    <td>
                                        <span class="badge tier-{{ legislator.tier.lower() }}">
                                            {{ legislator.tier }}
                                        </span>
                                    </td>
                                    <td>{{ legislator.current_score }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 하위 5명 -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>{{ title }} Worst 5</h5>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="bottom-view" id="bottom-chart-btn" autocomplete="off" checked>
                        <label class="btn btn-outline-primary btn-sm" for="bottom-chart-btn">차트</label>
                        
                        <input type="radio" class="btn-check" name="bottom-view" id="bottom-table-btn" autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="bottom-table-btn">목록</label>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 차트 뷰 -->
                    <div id="bottom-chart-view">
                        <canvas id="bottomChart" height="300"></canvas>
                    </div>
                    
                    <!-- 테이블 뷰 -->
                    <div id="bottom-table-view" class="d-none">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>순위</th>
                                    <th>사진</th>
                                    <th>의원명</th>
                                    <th>정당</th>
                                    <th>티어</th>
                                    <th>{{ title }} 점수</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for legislator in bottom_legislators %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>
                                        <img src="{{ legislator.profile_image_url }}" alt="{{ legislator.name }}" 
                                             class="rounded-circle" width="40" height="40" loading="lazy">
                                    </td>
                                    <td>
                                        <a href="/champions/{{ legislator.id }}">
                                            {{ legislator.name }}
                                        </a>
                                    </td>
                                    <td>{{ legislator.party }}</td>
                                    <td>
                                        <span class="badge tier-{{ legislator.tier.lower() }}">
                                            {{ legislator.tier }}
                                        </span>
                                    </td>
                                    <td>{{ legislator.current_score }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 전체 의원 랭킹 테이블 -->
    <div class="card">
        <div class="card-header">
            <h5>전체 의원 랭킹</h5>
        </div>
        <div class="card-body">
            <!-- 필터 영역 -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <form id="filter-form" class="row g-3">
                        <!-- 정당 필터 -->
                        <div class="col-md-3">
                            <label for="party" class="form-label">정당</label>
                            <select class="form-select" id="party" name="party">
                                <option value="">전체</option>
                                {% for party in parties %}
                                <option value="{{ party }}" {% if current_filters.party == party %}selected{% endif %}>{{ party }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- 위원회 필터 -->
                        <div class="col-md-3">
                            <label for="committee" class="form-label">위원회</label>
                            <select class="form-select" id="committee" name="committee">
                                <option value="">전체</option>
                                {% for committee in committees %}
                                <option value="{{ committee }}" {% if current_filters.committee == committee %}selected{% endif %}>{{ committee[:5] }}{% if committee|length > 5 %}{% endif %}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- 의원 경력 필터 -->
                        <div class="col-md-3">
                            <label for="term" class="form-label">의원 경력</label>
                            <select class="form-select" id="term" name="term">
                                <option value="">전체</option>
                                {% for term in terms %}
                                <option value="{{ term }}" {% if current_filters.term == term %}selected{% endif %}>{{ term }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- 성별 필터 -->
                        <div class="col-md-3">
                            <label for="gender" class="form-label">성별</label>
                            <select class="form-select" id="gender" name="gender">
                                <option value="">전체</option>
                                <option value="남" {% if current_filters.gender == "남" %}selected{% endif %}>남</option>
                                <option value="여" {% if current_filters.gender == "여" %}selected{% endif %}>여</option>
                            </select>
                        </div>
                        
                        <!-- 필터 버튼 -->
                        <div class="col-12">
                            <button type="button" id="apply-filter-btn" class="btn btn-primary">필터 적용</button>
                            <button type="button" id="reset-filter-btn" class="btn btn-secondary">필터 초기화</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- 테이블 -->
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>순위</th>
                            <th>사진</th>
                            <th>의원명</th>
                            <th>정당</th>
                            <th>티어</th>
                            <th class="sortable" onclick="sortTableByColumn(5)">
                                <span class="{{ 'font-weight-bold' if current_category == 'overall' else '' }}">
                                    종합 점수
                                    <span id="sort-5" class="sort-icon"></span>
                                </span>
                            </th>
                            <th class="sortable" onclick="sortTableByColumn(6)">
                                <span class="{{ 'font-weight-bold' if current_category == 'participation' else '' }}">
                                    참여도
                                    <span id="sort-6" class="sort-icon"></span>
                                </span>
                            </th>
                            <th class="sortable" onclick="sortTableByColumn(7)">
                                <span class="{{ 'font-weight-bold' if current_category == 'legislation' else '' }}">
                                    입법활동
                                    <span id="sort-7" class="sort-icon"></span>
                                </span>
                            </th>
                            <th class="sortable" onclick="sortTableByColumn(8)">
                                <span class="{{ 'font-weight-bold' if current_category == 'speech' else '' }}">
                                    의정발언
                                    <span id="sort-8" class="sort-icon"></span>
                                </span>
                            </th>
                            <th class="sortable" onclick="sortTableByColumn(9)">
                                <span class="{{ 'font-weight-bold' if current_category == 'voting' else '' }}">
                                    표결 책임성
                                    <span id="sort-9" class="sort-icon"></span>
                                </span>
                            </th>
                            <th class="sortable" onclick="sortTableByColumn(10)">
                                <span class="{{ 'font-weight-bold' if current_category == 'cooperation' else '' }}">
                                    정당 간 협력
                                    <span id="sort-10" class="sort-icon"></span>
                                </span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="ranking-table-body">
                        {% for legislator in all_legislators %}
                        <tr>
                            <td>{{ legislator.overall_rank }}</td>
                            <td>
                                <img src="{{ legislator.profile_image_url }}" alt="{{ legislator.name }}" 
                                     class="rounded-circle" width="40" height="40" loading="lazy">
                            </td>
                            <td>
                                <a href="/champions/{{ legislator.id }}">
                                    {{ legislator.name }}
                                </a>
                            </td>
                            <td>{{ legislator.party }}</td>
                            <td>
                                <span class="badge tier-{{ legislator.tier.lower() }}">
                                    {{ legislator.tier }}
                                </span>
                            </td>
                            <td class="{{ 'font-weight-bold' if current_category == 'overall' else '' }}">{{ legislator.overall_score }}</td>
                            <td class="{{ 'font-weight-bold' if current_category == 'participation' else '' }}">{{ legislator.participation_score }}</td>
                            <td class="{{ 'font-weight-bold' if current_category == 'legislation' else '' }}">{{ legislator.legislation_score }}</td>
                            <td class="{{ 'font-weight-bold' if current_category == 'speech' else '' }}">{{ legislator.speech_score }}</td>
                            <td class="{{ 'font-weight-bold' if current_category == 'voting' else '' }}">{{ legislator.voting_score }}</td>
                            <td class="{{ 'font-weight-bold' if current_category == 'cooperation' else '' }}">{{ legislator.cooperation_score }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    // 차트 데이터
    var chartData = JSON.parse('{{ chart_data|tojson }}');
    
    // 차트 옵션
    var chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: "top"
            }
        }
    };
    
    // 상위 5명 차트
    var topCtx = document.getElementById("topChart").getContext("2d");
    var topChart = new Chart(topCtx, {
        type: "bar",
        data: chartData.top,
        options: chartOptions
    });
    
    // 하위 5명 차트
    var bottomCtx = document.getElementById("bottomChart").getContext("2d");
    var bottomChart = new Chart(bottomCtx, {
        type: "bar",
        data: chartData.bottom,
        options: chartOptions
    });
    
    // 상위 5명 차트/테이블 토글
    document.getElementById("top-chart-btn").addEventListener("change", function() {
        document.getElementById("top-chart-view").classList.remove("d-none");
        document.getElementById("top-table-view").classList.add("d-none");
    });
    
    document.getElementById("top-table-btn").addEventListener("change", function() {
        document.getElementById("top-chart-view").classList.add("d-none");
        document.getElementById("top-table-view").classList.remove("d-none");
    });
    
    // 하위 5명 차트/테이블 토글
    document.getElementById("bottom-chart-btn").addEventListener("change", function() {
        document.getElementById("bottom-chart-view").classList.remove("d-none");
        document.getElementById("bottom-table-view").classList.add("d-none");
    });
    
    document.getElementById("bottom-table-btn").addEventListener("change", function() {
        document.getElementById("bottom-chart-view").classList.add("d-none");
        document.getElementById("bottom-table-view").classList.remove("d-none");
    });
    
    // 현재 카테고리에 해당하는 열 기준으로 기본 정렬
    var currentCategoryMap = {
        "overall": 5,
        "participation": 6,
        "legislation": 7,
        "speech": 8,
        "voting": 9,
        "cooperation": 10
    };
    
    var currentCategory = "{{ current_category }}";
    var columnIndex = currentCategoryMap[currentCategory];
    
    if (columnIndex !== undefined) {
        sortTableByColumn(columnIndex);
    }
});

// 정렬 상태 변수
var sortColumnIndex = -1;
var sortDirection = "desc";

// 테이블 정렬 함수
function sortTableByColumn(columnIndex) {
    var tableBody = document.getElementById("ranking-table-body");
    var rows = Array.from(tableBody.querySelectorAll("tr"));
    
    // 정렬 방향 결정
    if (sortColumnIndex === columnIndex) {
        sortDirection = sortDirection === "asc" ? "desc" : "asc";
    } else {
        sortColumnIndex = columnIndex;
        sortDirection = "desc";  // 기본 내림차순
    }
    
    // 정렬 아이콘 업데이트
    document.querySelectorAll(".sort-icon").forEach(function(icon) {
        icon.classList.remove("sort-asc", "sort-desc");
    });
    
    var currentIcon = document.getElementById("sort-" + columnIndex);
    if (currentIcon) {
        currentIcon.classList.add(sortDirection === "asc" ? "sort-asc" : "sort-desc");
    }
    
    // 행 정렬
    rows.sort(function(a, b) {
        var aValue = parseFloat(a.cells[columnIndex].textContent.trim()) || 0;
        var bValue = parseFloat(b.cells[columnIndex].textContent.trim()) || 0;
        
        if (sortDirection === "asc") {
            return aValue - bValue;
        } else {
            return bValue - aValue;
        }
    });
    
    // 정렬된 행으로 테이블 재구성
    rows.forEach(function(row, index) {
        // 순위 업데이트하지 않음 (원래의 overall_rank 유지)
        tableBody.appendChild(row);
    });
}


// 필터 적용 버튼 클릭 이벤트
document.getElementById("apply-filter-btn").addEventListener("click", function() {
    applyFilters();
});

// 필터 초기화 버튼 클릭 이벤트
document.getElementById("reset-filter-btn").addEventListener("click", function() {
    // 필터 폼 초기화
    document.getElementById("party").value = "";
    document.getElementById("committee").value = "";
    document.getElementById("term").value = "";
    document.getElementById("gender").value = "";
    
    // 필터 적용
    applyFilters();
});

// 필터 적용 함수
function applyFilters() {
    // 현재 스크롤 위치 저장
    const scrollPosition = window.scrollY;
    
    // 필터 값 가져오기
    const party = document.getElementById("party").value;
    const committee = document.getElementById("committee").value;
    const term = document.getElementById("term").value;
    const gender = document.getElementById("gender").value;
    
    // 현재 카테고리
    const currentCategory = "{{ current_category }}";
    
    // 로딩 표시
    const tableBody = document.getElementById("ranking-table-body");
    tableBody.innerHTML = '<tr><td colspan="11" class="text-center">데이터를 불러오는 중...</td></tr>';
    
    // API 요청 URL 구성
    let url = `/api/ranking/${currentCategory}?`;
    if (party) url += `&party=${encodeURIComponent(party)}`;
    if (committee) url += `&committee=${encodeURIComponent(committee)}`;
    if (term) url += `&term=${encodeURIComponent(term)}`;
    if (gender) url += `&gender=${encodeURIComponent(gender)}`;
    
    // AJAX 요청
    fetch(url)
        .then(response => response.json())
        .then(legislators => {
            // 테이블 업데이트
            updateRankingTable(legislators);
            
            // 원래 스크롤 위치로 복원
            window.scrollTo(0, scrollPosition);
        })
        .catch(error => {
            console.error('Error fetching data:', error);
            tableBody.innerHTML = '<tr><td colspan="11" class="text-center text-danger">데이터를 불러오는 중 오류가 발생했습니다.</td></tr>';
        });
}

// 테이블 업데이트 함수
function updateRankingTable(legislators) {
    const tableBody = document.getElementById("ranking-table-body");
    tableBody.innerHTML = "";
    
    legislators.forEach((legislator, index) => {
        const row = document.createElement("tr");
        
        // 티어에 따른 배지 클래스 결정
        let badgeClass = "bg-dark";
        if (legislator.tier === "Challenger") badgeClass = "bg-danger";
        else if (legislator.tier === "Master") badgeClass = "bg-warning";
        else if (legislator.tier === "Diamond") badgeClass = "bg-info";
        else if (legislator.tier === "Platinum") badgeClass = "bg-success";
        else if (legislator.tier === "Gold") badgeClass = "bg-warning text-dark";
        else if (legislator.tier === "Silver") badgeClass = "bg-secondary";
        
        // 현재 카테고리에 따른 강조
        const currentCategory = "{{ current_category }}";
        const participationClass = currentCategory === "participation" ? "font-weight-bold" : "";
        const legislationClass = currentCategory === "legislation" ? "font-weight-bold" : "";
        const speechClass = currentCategory === "speech" ? "font-weight-bold" : "";
        const votingClass = currentCategory === "voting" ? "font-weight-bold" : "";
        const cooperationClass = currentCategory === "cooperation" ? "font-weight-bold" : "";
        const overallClass = currentCategory === "overall" ? "font-weight-bold" : "";
        
        // 행 내용 구성
        row.innerHTML = `
            <td>${legislator.overall_rank}</td>
            <td>
                <img src="${legislator.profile_image_url}" alt="${legislator.name}" 
                     class="rounded-circle" width="40" height="40" loading="lazy">
            </td>
            <td>
                <a href="/champions/${legislator.id}">
                    ${legislator.name}
                </a>
            </td>
            <td>${legislator.party}</td>
            <td>
                <span class="badge ${badgeClass}">
                    ${legislator.tier}
                </span>
            </td>
            <td class="${overallClass}">${legislator.overall_score}</td>
            <td class="${participationClass}">${legislator.participation_score}</td>
            <td class="${legislationClass}">${legislator.legislation_score}</td>
            <td class="${speechClass}">${legislator.speech_score}</td>
            <td class="${votingClass}">${legislator.voting_score}</td>
            <td class="${cooperationClass}">${legislator.cooperation_score}</td>
        `;
        
        tableBody.appendChild(row);
    });
}
</script>
{% endblock %}